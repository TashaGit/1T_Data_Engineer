# Проект № 7

### Данный проект берет за основу проект № 2, но с иным источником извлечения данных и расширенным функционалом.

```
Анализ рынка курса акций самых популярных российских компаний.

Общая задача: создать ETL-процесс формирования витрин данных для анализа изменений курса акций.

Подробное описание задачи:

1. Разработка скрипты загрузки данных в 2-х режимах:

- Инициализирующий — загрузка полного слепка данных источника
- Инкрементальный — загрузка дельты данных за прошедшие сутки

2. Организация структуры хранения данных:

- Сырой слой данных
- Промежуточный слой
- Слой витрин.
```

## Описание проекта.

Проект разработан для загрузки и анализа данных о ценах акций на Московской Бирже. 
В качестве источника данных используется открытый API Московской биржи: http://iss.moex.com/iss/.

Исследуем данные по акциям предприятий:

- GAZP - Gazprom (Газпром) - крупный российский энергетический концерн, занимающийся добычей, переработкой, транспортом 
         и продажей природного газа.
- SBER - Sberbank (Сбербанк) - крупнейший банк России и один из ведущих финансовых институтов СНГ, предоставляющий 
         широкий спектр банковских услуг.
- GMKN - Norilsk Nickel (Норильский никель) - российская металлургическая компания и один из крупнейших мировых 
         производителей никеля, палладия, платины и меди.
- VTBR - VTB Bank (ВТБ Банк) - один из крупнейших банков России, оказывающий широкий спектр финансовых услуг для 
         корпоративных и частных клиентов. Банк активно занимается инвестированием в различные отрасли экономики, в том 
         числе в финансовый сектор, розничную торговлю, производство и недвижимость.
- YNDX - Yandex (Яндекс) - это крупнейшая российская интернет-компания, специализирующаяся на разработке и 
         предоставлении услуг в области поисковой системы, электронной коммерции, интернет-медиа, онлайн-транспорт и 
         других сферах. 

Размер извлекаемых данных не считается большим, поскольку при использовании интервала в 60 минут мы получаем порядка 30 000 строк, а при интервале в 10 минут - порядка 170 000 строк. В связи с этим было принято решение использовать PostgreSQL для хранения и обработки данных, а для создания конвейера, включающего сбор, сохранение, преобразование и агрегацию данных для построения витрин - Apache Airflow.

## Структура директории проекта и его запуск

![tree.png](src%2FPictures%2Ftree.png)

1. В терминале перейти в папку ***Project_files*** и выполнить команду ***docker-compose up -d***;
2. Перейти в WEB-интерфейс Airflow по ссылке http://localhost:8080/ (login: airflow, password: airflow) и прописать настройки подключения в Admin -> Connections (пароль password):
   ![connection.png](src%2FPictures%2Fconnection.png) 
3. Параметры Variables прописаны в конфигурационном файле [config.json](src%2FProject_files%2Fairflow%2Fdags%2Fconfig.json) и загружаются в Airflow автоматически;
4. Запустить в ручном режиме one_time_start_dag (отслеживать в logs полного исполнения Dag);
4. Для первого запуска daily_update_dag нужно прописать время его запуска в коде (изменить **schedule_interval='45 05 * * *'**):
    
        daily_update_dag = DAG(dag_id='daily_update_dag',
                       tags=['daily_update'],
                       start_date=datetime(2023, 9, 9),
                       # schedule_interval=timedelta(days=1),
                       catchup=False,
                       schedule_interval='45 05 * * *',
                       default_args=default_args)

  ❗Запускать принудительно - не по расписанию - категорически не рекомендуется во избежание дублирования записей в БД.
    
В случае дублирования записей при первичном запуске Dag вручную рекомендуется запустить его еще раз для перезаписи данных.

## Структура проекта

### Проект состоит из двух основных рабочих процессов (DAGs) в Apache Airflow:

#### 1. Процесс one_time_start_dag: запускается вручную для сбора исторических данных и их загрузки в базу данных PostgreSQL.
- create_csv_files: скачивание исторических данных (60-минутные свечи) с API Московской биржи и сохранение их в CSV-файлах.
- create_raw_tables: создание отношений в базе данных РostgreSQL (Raw layer);
- load_data: загрузка данных из CSV-файлов в Raw - слой;
- execute_ddl: создание таблиц на слое Core;
- execute_dml: заполнение таблиц на слое Core.

- GRAPH:

![one_time_start_graph.png](src%2FPictures%2Fone_time_start_graph.png)

- DAG:

![one_time_start_dag.png](src%2FPictures%2Fone_time_start_dag.png)
#### 2. Процесс daily_update_dag: запускается ежедневно для сбора и анализа новых данных за последний день.
Выполняет следующие задачи:
- downl_raw_last_day: скачивание данных за последний день и сохранение их в таблицах базы данных;
- create_data_mart: создание витрины (агрегированные данные) на основе обновленной информации за последний день;
- create_statistic_mart: создание витрины с обновленными статистическими данными за всю историю;

- GRAPH:

![daily_update_graph.png](src%2FPictures%2Fdaily_update_graph.png)

- DAG:

![daily_update_dag.png](src%2FPictures%2Fdaily_update_dag.png)

### Графическая структура проекта:

![plant_UML_big2.png](src%2FPictures%2Fplant_UML_big2.png)


## Результаты

### ER - диаграмма сформированных данных:

![ER_with_names.png](src%2FPictures%2FER_with_names.png)

### В результате выполнения проекта создаются витрины с обновленными данными по акциям: 

#### 1. Витрина data_mart, содержащая данные по акциям за последний день:

- Суррогатный ключ категории;
- Название акции;
- Суммарный объем торгов за последние сутки;
- Курс акций на момент открытия торгов для данных суток;
- Курс акций на момент закрытия торгов для данных суток;
- Разница (в %) курса с момента открытия до момента закрытия торгов для данных суток;
- Минимальный временной интервал, на котором был зафиксирован самый крупный объем торгов для данных суток;
- Минимальный временной интервал, на котором был зафиксирован максимальный курс для данных суток;
- Минимальный временной интервал, на котором был зафиксирован минимальный курс торгов для данных суток.

|surrogate_key|company|date_stock|total_share|open_val|close_val|percentage_difference|max_volume_interval|max_price_interval|min_price_interval|
|-------------|-------|----------|-----------|--------|---------|---------------------|-------------------|------------------|------------------|
|GAZP|Газпром|2023-09-08|5390934877.50|177.94|175.95|1.1310|(10:00:00,10:59:59)|(11:00:00,11:59:59)|(21:00:00,21:59:59)|
|SBER|Сбербанк России|2023-09-08|12703139529.30|258.08|255.68|0.9387|(10:00:00,10:59:59)|(16:00:00,16:59:59)|(17:00:00,17:59:59)|
|GMKN|Норильский никель|2023-09-08|2317900832.00|16498|16320|1.0907|(10:00:00,10:59:59)|(10:00:00,10:59:59)|(13:00:00,13:59:59)|
|VTBR|Банк ВТБ|2023-09-08|4425432189.30|0.02767|0.02719|1.7654|(10:00:00,10:59:59)|(20:00:00,20:59:59)|(23:00:00,23:59:55)|
|YNDX|Яндекс|2023-09-08|2210724516.00|2585.6|2547.6|1.4916|(10:00:00,10:59:59)|(17:00:00,17:59:59)|(22:00:00,22:59:59)|

#### 2. Витрина statistic_mart, содержащая статистические данные по акциям за всю историю хранения данных:

- Суррогатный ключ категории;
- Название акции;
- Первый день исторических данных;
- Последний загруженный день;
- Максимальная сумма продаж за всю историю на интервале 60 минут;
- Дата максимальной суммы оборота акций;
- Минимальная сумма продаж за всю историю на интервале 60 минут;
- Дата минимальной суммы оборота акций;
- Максимальный количественный объем продаж за всю историю на интервале 60 минут;
- Дата максимального объема продаж акций;
- Минимальный количественный объем продаж за всю историю на интервале 60 минут;
- Дата минимального объема продаж акций;
- Максимальная цена продаж акций за всю историю хранения данных;
- Дата зафиксированной максимальной цены акции;
- Минимальная цена продаж акций за всю историю хранения данных;
- Дата зафиксированной минимальной цены акции.

|surrogate_key|company|first_day|last_day|max_share|date_max_share|min_share|date_min_share|max_volume|date_max_vol|min_volume|date_min_vol|max_price|date_max_price|min_price|date_min_price|
|-------------|-------|---------|--------|---------|--------------|---------|--------------|----------|------------|----------|------------|---------|--------------|---------|--------------|
|GAZP|Газпром|2014-06-09|2023-09-08|22087856841.10|2020-05-29|12329.10|2016-02-22|110638830|2020-05-29|90|2014-10-10|397.64|2021-10-06|111.46|2017-06-15|
|SBER|Сбербанк России|2011-11-17|2023-09-08|28656220309.20|2022-02-21|314132.00|2021-07-16|151123740|2023-03-17|1040|2017-08-02|388.11|2021-10-11|47.21|2014-12-16|
|GMKN|Норильский никель|2014-06-09|2023-09-08|11683929180.00|2021-04-27|11560.00|2018-07-06|447757|2021-02-25|1|2014-06-20|28224|2021-02-19|6548|2014-06-16|
|VTBR|Банк ВТБ|2013-02-28|2023-09-08|5477053414.10|2023-08-10|473.30|2018-01-03|224944180000|2023-04-05|10000|2015-09-17|0.0832|2015-05-27|0.01388|2022-10-10|
|YNDX|Яндекс|2014-06-04|2023-09-08|82133186552.60|2020-08-31|822.00|2015-08-19|15939573|2020-08-31|1|2014-06-20|6217.0|2021-11-08|683.0|2015-09-29|
